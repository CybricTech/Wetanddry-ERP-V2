// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// Fleet Management Module

model Truck {
  id              String    @id @default(cuid())
  plateNumber     String    @unique
  model           String
  capacity        String?   // e.g., "8m³"
  status          String    @default("Available") // Available, In Use, Maintenance
  purchaseDate    DateTime
  mileage         Int       @default(0)
  lastServiceDate DateTime?
  nextServiceDate DateTime?
  nextServiceMileage Int?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  maintenanceRecords MaintenanceRecord[]
  maintenanceSchedules MaintenanceSchedule[]
  parts              Part[]
  fuelLogs           FuelLog[]
  exceptionLogs      ExceptionLog[]
  documents          TruckDocument[]
  expenses           Expense[]         // Transport/fuel expenses linked to this truck
}

model TruckDocument {
  id               String   @id @default(cuid())
  truckId          String
  truck            Truck    @relation(fields: [truckId], references: [id], onDelete: Cascade)
  name             String
  type             String   // "Registration", "Insurance", "Inspection", "Maintenance", "Other"
  url              String
  cloudinaryPublicId String
  expiryDate       DateTime?
  notes            String?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
}

model MaintenanceRecord {
  id          String   @id @default(cuid())
  truckId     String
  truck       Truck    @relation(fields: [truckId], references: [id], onDelete: Cascade)
  date        DateTime
  type        String   // e.g., Oil Change, Tire Replacement
  cost        Float
  mileageAtService Int?
  status      String   @default("Completed") // Completed, Scheduled, Overdue
  notes       String?
  performedBy String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// Maintenance Scheduler - Automated alerts for service intervals
model MaintenanceSchedule {
  id              String   @id @default(cuid())
  truckId         String
  truck           Truck    @relation(fields: [truckId], references: [id], onDelete: Cascade)
  type            String   // e.g., Oil Change, Brake Inspection, Full Service
  intervalType    String   // "date" or "mileage" or "both"
  intervalDays    Int?     // e.g., 90 days
  intervalMileage Int?     // e.g., 10000 km
  nextDueDate     DateTime?
  nextDueMileage  Int?
  lastCompletedDate DateTime?
  isActive        Boolean  @default(true)
  priority        String   @default("Normal") // Low, Normal, High, Critical
  notes           String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

// Component Lifecycle Tracking - For high-wear components (Tires, Batteries)
model Part {
  id              String   @id @default(cuid())
  truckId         String
  truck           Truck    @relation(fields: [truckId], references: [id], onDelete: Cascade)
  partNumber      String
  name            String
  category        String   // e.g., Tire, Battery, Brake Pad, Filter
  position        String?  // e.g., Front Left, Rear Right, Engine Bay
  installedDate   DateTime
  lifespanMonths  Int      // Expected lifespan in months
  lifespanMileage Int?     // Expected lifespan in kilometers
  mileageAtInstall Int?    // Truck mileage when part was installed
  expectedReplacementDate DateTime?
  purchasePrice   Float?
  supplier        String?
  warrantyExpiry  DateTime?
  status          String   @default("Active") // Active, Due for Replacement, Replaced
  notes           String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

// Spare Parts Inventory - Track spare parts by Part Number, Purchase Price, Quantity
model SparePartInventory {
  id            String   @id @default(cuid())
  partNumber    String   @unique
  name          String
  category      String   // e.g., Tire, Battery, Filter, Brake Pad
  description   String?
  quantity      Int      @default(0)
  minQuantity   Int      @default(1) // Threshold for low stock alert
  purchasePrice Float
  supplier      String?
  location      String?  // Storage location
  lastRestocked DateTime?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

// Inventory Management Module

model StorageLocation {
  id          String   @id @default(cuid())
  name        String   @unique // e.g., "Silo 1", "Silo 2", "Main Warehouse", "Container 1"
  type        String   // "Silo", "Container", "Warehouse", "Shelf"
  description String?
  capacity    Float?   // Maximum capacity (for silos/containers, in kg)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  items          InventoryItem[]
  productionRuns ProductionRun[]
  stockReconciliations StockReconciliation[]
}

model InventoryItem {
  id              String   @id @default(cuid())
  name            String
  sku             String?
  category        String   // "Asset", "Consumable", "Equipment"
  itemType        String   @default("General") // e.g., "Cement", "Aggregate", "Admixture", "General"
  quantity        Float    @default(0)
  maxCapacity     Float?   // Maximum storage capacity (for silos)
  unit            String   // e.g., "kg", "liters", "pcs"
  minThreshold    Float    @default(0)
  unitCost        Float    @default(0)  // Cost per unit
  totalValue      Float    @default(0)  // Calculated: quantity * unitCost
  expiryDate      DateTime?
  batchNumber     String?  // For traceability
  supplier        String?
  recipeIngredients RecipeIngredient[] // Relation to recipes
  
  locationId      String
  location        StorageLocation @relation(fields: [locationId], references: [id])
  
  transactions    StockTransaction[]
  materialRequests MaterialRequest[]
  priceHistory    MaterialPriceHistory[]
  reconciliationItems ReconciliationItem[]
  productionMaterialUsages ProductionMaterialUsage[]

  // Approval workflow
  status          String   @default("Active") // "Pending", "Active", "Rejected"
  approvedBy      String?  // Who approved the item
  approvedAt      DateTime?

  createdBy       String?  // User name who added the item
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

model StockTransaction {
  id          String   @id @default(cuid())
  itemId      String
  item        InventoryItem @relation(fields: [itemId], references: [id])
  type        String   // "IN", "OUT", "ADJUSTMENT"
  quantity    Float
  reason      String?
  
  // Delivery/Supplier Details (for Stock In)
  supplierName    String?
  invoiceNumber   String?
  waybillNumber   String?
  deliveryDate    DateTime?
  batchNumber     String?  // For material traceability (non-cement)
  atcNumber       String?  // ATC Number for cement deliveries
  unitCostAtTime  Float?   // Cost per unit at time of delivery
  totalCost       Float?   // quantity * unitCostAtTime
  
  status      String   @default("Pending") // "Pending", "Approved", "Rejected"
  performedBy String?  // User ID or Name
  receivedBy  String?  // Who physically received the delivery
  approvedBy  String?  // Approver for the transaction
  approvedAt  DateTime?
  notes       String?
  createdAt   DateTime @default(now())
}

// Material Request Workflow - For approval process
model MaterialRequest {
  id              String   @id @default(cuid())
  requestType     String   // "Stock In", "Stock Out", "Transfer"
  itemId          String
  item            InventoryItem @relation(fields: [itemId], references: [id])
  quantity        Float
  fromLocationId  String?  // For transfers
  toLocationId    String?  // For transfers
  reason          String?
  priority        String   @default("Normal") // "Low", "Normal", "High", "Urgent"
  status          String   @default("Pending") // "Pending", "Approved", "Rejected", "Completed"
  requestedBy     String
  approvedBy      String?
  approvedAt      DateTime?
  completedAt     DateTime?
  rejectionReason String?
  notes           String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

// Production & Mixology Module

model Recipe {
  id          String   @id @default(cuid())
  productCode String   @unique // e.g. "C10", "C15"
  name        String   // e.g., "Standard Concrete (C25)"
  description String?
  totalWeight Float    @default(0) // Auto-calculated total batch weight
  ingredients RecipeIngredient[]
  runs        ProductionRun[]
  exceptionLogs ExceptionLog[]
  orderLineItems OrderLineItem[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model RecipeIngredient {
  id           String   @id @default(cuid())
  recipeId     String
  recipe       Recipe   @relation(fields: [recipeId], references: [id])
  inventoryItemId String
  inventoryItem InventoryItem @relation(fields: [inventoryItemId], references: [id])
  materialName String   // Cached name or specific role (e.g. "20mm Aggregate")
  quantity     Float    // Amount required per 1 unit of production
  unit         String   // e.g., "kg"
}

model ProductionRun {
  id          String   @id @default(cuid())
  recipeId    String
  recipe      Recipe   @relation(fields: [recipeId], references: [id])
  siloId      String?  // Which silo the cement was drawn from
  silo        StorageLocation? @relation(fields: [siloId], references: [id])
  
  // Client Attribution (CRM Integration)
  clientId    String?  // Which client ordered this batch
  client      Client?  @relation(fields: [clientId], references: [id])
  orderRef    String?  // Client's PO/Order reference number
  deliveryAddress String? // Specific delivery location for this batch
  
  // Order Linking
  orderId         String?
  order           SalesOrder? @relation(fields: [orderId], references: [id])
  orderLineItemId String?
  
  // Scheduling
  scheduledDate   DateTime?
  plannedStartTime DateTime?
  plannedEndTime  DateTime?
  actualStartTime DateTime?
  actualEndTime   DateTime?
  
  // Variance Tracking
  plannedQuantity Float?   // Planned m³
  quantity    Float    // Actual amount produced (m³)
  cementUsed  Float?   // Amount of cement deducted from silo (kg)
  
  // Status: "Scheduled" | "In Progress" | "Completed" | "Delayed" | "Rescheduled" | "Cancelled"
  status      String   @default("Completed")
  
  // Delay/Reschedule
  delayReason     String?
  rescheduledFrom DateTime?
  
  notes       String?
  operatorName String?
  createdAt   DateTime @default(now())
  
  // Material Usage Tracking
  materialUsages ProductionMaterialUsage[]
  
  @@index([clientId])
  @@index([orderId])
}

// Diesel & Fuel Intelligence Module

model Equipment {
  id          String    @id @default(cuid())
  name        String    // e.g., "Generator 1", "Pump Station A"
  type        String    // "Generator", "Pump", "Compressor", "Other"
  status      String    @default("Active") // Active, Inactive, Maintenance
  notes       String?
  fuelLogs    FuelLog[]
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
}

model FuelLog {
  id          String     @id @default(cuid())
  truckId     String?
  truck       Truck?     @relation(fields: [truckId], references: [id])
  equipmentId String?
  equipment   Equipment? @relation(fields: [equipmentId], references: [id])
  date        DateTime   @default(now())
  liters      Float
  cost        Float
  mileage     Int?       // Mileage at time of fueling (trucks only)
  efficiency  Float?     // Calculated km/L (trucks only)
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  @@index([truckId])
  @@index([equipmentId])
}

model FuelDeposit {
  id            String   @id @default(cuid())
  date          DateTime @default(now())
  liters        Float
  pricePerLiter Float
  totalCost     Float
  supplier      String?
  notes         String?
  recordedBy    String
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}


// Exception Handling Module (Dump & Divert)

model ExceptionLog {
  id          String   @id @default(cuid())
  type        String   // "Dump" or "Divert"
  reason      String   // e.g., "Bad Mix", "Truck Breakdown", "Client Rejection"
  quantity    Float    // Amount wasted/diverted
  unit        String   // e.g., "m3"
  
  truckId     String?
  truck       Truck?   @relation(fields: [truckId], references: [id])
  
  recipeId    String?
  recipe      Recipe?  @relation(fields: [recipeId], references: [id])
  
  // Client Attribution (CRM Integration)
  clientId    String?
  client      Client?  @relation(fields: [clientId], references: [id])

  notes       String?
  reportedBy  String?
  resolved    Boolean  @default(false)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([clientId])
}

// User Management Module

model User {
  id        String   @id @default(cuid())
  name      String
  email     String   @unique
  password  String
  role      String   @default("Storekeeper") // "Super Admin", "Manager", "Storekeeper", "Accountant"
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String?  // ID of admin who created this user
  updatedBy String?  // ID of admin who last modified this user

  // Relations
  notifications             Notification[]
  notificationPreference    UserNotificationPreference?
}

// Notification System Module

model Notification {
  id          String   @id @default(cuid())
  type        String   // notification type key (e.g., "approval_request", "low_stock", etc.)
  title       String
  message     String
  priority    String   @default("medium") // "low", "medium", "high", "critical"
  
  // Targeting
  userId      String   // recipient user ID
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Status
  read        Boolean  @default(false)
  readAt      DateTime?
  
  // Context (optional references for navigation)
  entityType  String?  // "inventory_item", "stock_transaction", "exception", "truck", "material_request"
  entityId    String?  // ID of related entity for click-through navigation
  
  createdAt   DateTime @default(now())

  @@index([userId, read])
  @@index([userId, createdAt])
}

model UserNotificationPreference {
  id                String   @id @default(cuid())
  userId            String   @unique
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Browser push notifications
  pushEnabled       Boolean  @default(false)
  pushSubscription  String?  // JSON stringified PushSubscription from browser
  
  // Per-type preferences stored as JSON
  // Format: { "type_key": { "inApp": true, "push": false } }
  preferences       String   @default("{}")
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
}

// Staff Registry Module

model Staff {
  id          String   @id @default(cuid())
  firstName   String
  lastName    String
  role        String
  department  String
  email       String?
  phone       String
  address     String
  status      String   @default("Active") // Active, On Leave, Terminated, Contract
  joinedDate  DateTime
  
  documents   StaffDocument[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model StaffDocument {
  id               String   @id @default(cuid())
  staffId          String
  staff            Staff    @relation(fields: [staffId], references: [id], onDelete: Cascade)
  name             String
  type             String   // "ID", "Contract", "Agreement", "Other"
  url              String
  cloudinaryPublicId String
  expiryDate       DateTime?
  notes            String?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
}

// ==================== CRM MODULE ====================

model Client {
  id              String   @id @default(cuid())
  
  // Basic Information
  code            String   @unique  // e.g., "CLI-001", auto-generated
  name            String            // Company or individual name
  type            String   @default("Business")  // "Business", "Individual", "Government"
  
  // Contact Details
  email           String?
  phone           String
  altPhone        String?
  address         String
  city            String
  state           String
  
  // Business Information
  taxId           String?           // VAT/TIN number
  paymentTerms    String   @default("Net 30")  // "COD", "Net 15", "Net 30", "Net 60"
  creditLimit     Float?            // Maximum credit allowed (Naira)
  currentBalance  Float    @default(0)  // Outstanding balance
  
  // Classification
  category        String   @default("Regular")  // "VIP", "Regular", "New", "Dormant"
  tags            String?           // JSON array of tags for flexible categorization
  
  // Status & Tracking
  status          String   @default("Active")  // "Active", "Inactive", "Suspended", "Blacklisted"
  notes           String?
  
  // Audit
  createdBy       String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Wallet/Prepayment
  walletBalance   Float    @default(0)  // Available prepayment credits
  
  // Relations
  contacts        ClientContact[]
  documents       ClientDocument[]
  expenses        Expense[]
  productionRuns  ProductionRun[]
  exceptionLogs   ExceptionLog[]
  projects        Project[]
  prepayments     Prepayment[]
  orders          SalesOrder[]
  
  @@index([code])
  @@index([status])
  @@index([category])
}

model ClientContact {
  id          String   @id @default(cuid())
  clientId    String
  client      Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  
  name        String
  role        String?           // "Site Manager", "Procurement", "Finance", etc.
  email       String?
  phone       String
  isPrimary   Boolean  @default(false)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([clientId])
}

model ClientDocument {
  id                 String   @id @default(cuid())
  clientId           String
  client             Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  
  name               String
  type               String   // "Contract", "Agreement", "Quote", "Invoice", "Other"
  url                String
  cloudinaryPublicId String
  expiryDate         DateTime?
  notes              String?
  
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
  
  @@index([clientId])
}

model Expense {
  id             String   @id @default(cuid())
  
  // Expense Details
  category       String            // "Transport", "Materials", "Labor", "Equipment", "Maintenance", "Administrative", "Other"
  description    String
  amount         Float
  
  // Date & Reference
  date           DateTime @default(now())
  invoiceNumber  String?
  receiptUrl     String?
  receiptPublicId String?          // Cloudinary public ID for receipt
  
  // Client Attribution (optional - for client-specific expenses)
  clientId       String?
  client         Client?  @relation(fields: [clientId], references: [id])
  
  // Truck Attribution (optional - for transport/fuel expenses)
  truckId        String?
  truck          Truck?   @relation(fields: [truckId], references: [id])
  
  // Status & Approval Workflow
  status         String   @default("Pending")  // "Pending", "Approved", "Rejected"
  approvedBy     String?
  approvedAt     DateTime?
  rejectionReason String?
  
  // Audit
  recordedBy     String
  notes          String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  
  @@index([clientId])
  @@index([category])
  @@index([date])
  @@index([status])
}

// ==================== PROJECT & ORDER MANAGEMENT MODULE ====================

model Project {
  id              String   @id @default(cuid())
  clientId        String
  client          Client   @relation(fields: [clientId], references: [id])
  name            String
  description     String?
  startDate       DateTime?
  endDate         DateTime?
  status          String   @default("Active") // Active, Completed, On Hold, Cancelled
  createdBy       String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  orders          SalesOrder[]
  prepayments     Prepayment[]
  
  @@index([clientId])
  @@index([status])
}

model Prepayment {
  id              String   @id @default(cuid())
  clientId        String
  client          Client   @relation(fields: [clientId], references: [id])
  projectId       String?
  project         Project? @relation(fields: [projectId], references: [id])
  amount          Float
  paymentMethod   String   // Cash, Bank Transfer, Cheque
  referenceNumber String?
  notes           String?
  status          String   @default("Received") // Received, Applied, Refunded
  receivedDate    DateTime @default(now())
  receivedBy      String
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([clientId])
  @@index([projectId])
  @@index([status])
}

model SalesOrder {
  id                  String   @id @default(cuid())
  orderNumber         String   @unique
  clientId            String
  client              Client   @relation(fields: [clientId], references: [id])
  projectId           String?
  project             Project? @relation(fields: [projectId], references: [id])
  
  orderDate           DateTime @default(now())
  requiredDate        DateTime?
  deliveryAddress     String?
  
  // Status: "Draft" | "Pending" | "Active" | "Fulfilled" | "Closed" | "Cancelled"
  status              String   @default("Draft")
  totalAmount         Float    @default(0)
  amountPaid          Float    @default(0)
  activationThreshold Float    @default(0.3) // 30% default to activate order
  
  notes               String?
  createdBy           String
  approvedBy          String?
  approvedAt          DateTime?
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  
  lineItems           OrderLineItem[]
  payments            Payment[]
  paymentSchedule     PaymentScheduleItem[]
  productionRuns      ProductionRun[]
  
  @@index([clientId])
  @@index([projectId])
  @@index([status])
  @@index([orderDate])
}

model OrderLineItem {
  id              String     @id @default(cuid())
  orderId         String
  order           SalesOrder @relation(fields: [orderId], references: [id], onDelete: Cascade)
  recipeId        String
  recipe          Recipe     @relation(fields: [recipeId], references: [id])
  
  cubicMeters     Float      // m³ ordered
  unitPrice       Float      // Price per m³
  lineTotal       Float      // cubicMeters * unitPrice
  productType     String     // Cached recipe name/code
  
  deliveredQty    Float      @default(0) // m³ delivered
  status          String     @default("Pending") // Pending, Partial, Fulfilled
  
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt
  
  @@index([orderId])
  @@index([recipeId])
}

model Payment {
  id              String     @id @default(cuid())
  orderId         String
  order           SalesOrder @relation(fields: [orderId], references: [id])
  
  amount          Float
  paymentDate     DateTime   @default(now())
  paymentMethod   String     // Cash, Bank Transfer, Cheque, Prepayment Drawdown
  referenceNumber String?
  prepaymentId    String?    // If drawing from prepayment
  
  status          String     @default("Received") // Received, Verified, Bounced
  receivedBy      String
  notes           String?
  
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt
  
  @@index([orderId])
  @@index([paymentDate])
}

model PaymentScheduleItem {
  id              String     @id @default(cuid())
  orderId         String
  order           SalesOrder @relation(fields: [orderId], references: [id], onDelete: Cascade)
  
  dueDate         DateTime
  amount          Float
  description     String?    // e.g., "30% Deposit", "2nd Installment"
  status          String     @default("Pending") // Pending, Paid, Overdue
  paidDate        DateTime?
  paymentId       String?    // Link to actual payment
  
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt
  
  @@index([orderId])
  @@index([dueDate])
  @@index([status])
}

// ==================== PRICE HISTORY & COSTING MODULE ====================

model MaterialPriceHistory {
  id              String        @id @default(cuid())
  inventoryItemId String
  inventoryItem   InventoryItem @relation(fields: [inventoryItemId], references: [id])
  
  price           Float
  effectiveDate   DateTime      @default(now())
  source          String?       // "Delivery", "Manual Adjustment", "Market Update"
  transactionId   String?       // Link to StockTransaction if from delivery
  notes           String?
  recordedBy      String
  
  createdAt       DateTime      @default(now())
  
  @@index([inventoryItemId])
  @@index([effectiveDate])
}

// ==================== STOCK RECONCILIATION MODULE ====================

model StockReconciliation {
  id                  String           @id @default(cuid())
  reconciliationDate  DateTime         @default(now())
  locationId          String?          // Null means all locations
  location            StorageLocation? @relation(fields: [locationId], references: [id])
  
  status              String           @default("Draft") // Draft, In Progress, Completed, Cancelled
  totalVariance       Float            @default(0)
  varianceValue       Float            @default(0)
  
  performedBy         String
  approvedBy          String?
  approvedAt          DateTime?
  notes               String?
  
  createdAt           DateTime         @default(now())
  updatedAt           DateTime         @updatedAt
  
  items               ReconciliationItem[]
  
  @@index([locationId])
  @@index([status])
  @@index([reconciliationDate])
}

model ReconciliationItem {
  id                  String              @id @default(cuid())
  reconciliationId    String
  reconciliation      StockReconciliation @relation(fields: [reconciliationId], references: [id], onDelete: Cascade)
  inventoryItemId     String
  inventoryItem       InventoryItem       @relation(fields: [inventoryItemId], references: [id])
  
  systemQuantity      Float               // Quantity per system
  physicalQuantity    Float               // Actual count
  variance            Float               // physicalQuantity - systemQuantity
  varianceValue       Float               // variance * unitCost
  reason              String?             // Loss, Gain, Damage, Theft, Error
  
  adjustmentPosted    Boolean             @default(false)
  transactionId       String?             // Link to created StockTransaction
  
  createdAt           DateTime            @default(now())
  
  @@index([reconciliationId])
  @@index([inventoryItemId])
}

// ==================== PRODUCTION MATERIAL USAGE TRACKING ====================

model ProductionMaterialUsage {
  id                String        @id @default(cuid())
  productionRunId   String
  productionRun     ProductionRun @relation(fields: [productionRunId], references: [id], onDelete: Cascade)
  inventoryItemId   String
  inventoryItem     InventoryItem @relation(fields: [inventoryItemId], references: [id])
  
  plannedQuantity   Float         // From recipe calculation
  actualQuantity    Float?        // Actual used
  variance          Float?        // actual - planned
  unitCostAtTime    Float?        // For costing
  
  createdAt         DateTime      @default(now())
  
  @@index([productionRunId])
  @@index([inventoryItemId])
}

// Duplicate Alert System

model DuplicateAlert {
  id           String    @id @default(cuid())
  entityType   String    // "InventoryItem", "Client", "Staff"
  entityId1    String
  entityId2    String
  field        String    // "name", "phone", "email"
  value        String    // The duplicate value found
  status       String    @default("Open") // "Open", "Resolved", "Ignored"
  resolvedBy   String?
  resolvedAt   DateTime?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  @@unique([entityType, entityId1, entityId2, field])
  @@index([status])
  @@index([entityType])
}
